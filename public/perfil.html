<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="utf-8">
  <title>Chat Tradutor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
  <main class="content">
    <div class="container p-0">
      <h1 class="h3 mb-3">MEU PERFIL</h1>
      <div class="card">
        <div class="row g-0 mx-0 px-0">
          <div class="col-12 col-lg-5 col-xl-3 border-right" style="max-height: 80vh; overflow-y: scroll;">
            <a href="home.html" class="list-group-item list-group-item-action border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="home"></ion-icon></div>
                <div class="flex-grow-1 ml-3">
                  Início
                </div>
              </div>
            </a>
            <a href="chat.html" class="list-group-item list-group-item-action border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="paper-plane"></ion-icon></div>
                <div class="flex-grow-1 ml-3">
                  Conversas
                </div>
              </div>
            </a>
            <a href="perfil.html" class="list-group-item list-group-item-action active border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="contact"></ion-icon></div>
                <div class="flex-grow-1 ml-3">
                  Perfil
                </div>
              </div>
            </a>
            <a href="definicoes.html" class="list-group-item list-group-item-action border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="cog"></ion-icon></div>
                <div class="flex-grow-1 ml-3">
                  Definições
                </div>
              </div>
            </a>
            <a href="ajuda.html" class="list-group-item list-group-item-action border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="help-circle"></ion-icon></div>
                <div class="flex-grow-1 ml-3">
                  Ajuda
                </div>
              </div>
            </a>
            <a href="sobre.html" class="list-group-item list-group-item-action border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="information-circle"></ion-icon></div>
                <div class="flex-grow-1 ml-3">
                  Sobre
                </div>
              </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action border-0">
              <div class="d-flex align-items-start">
                <div class="icons"><ion-icon name="power"></ion-icon></div>
                <div class="flex-grow-1 ml-3" onclick="terminarSesao()">
                  Terminar Sessão
                </div>
              </div>
            </a>
            <hr class="d-block d-lg-none mt-1 mb-0">
          </div>
          <div class="col-12 col-lg-7 col-xl-9">
            <div class="py-2 px-4 border-bottom d-none d-lg-block">
              <div class="d-flex align-items-center py-1">
                <div class="position-relative">
                  <img src="assets/imgs/user.png" class="rounded-circle mr-1 userPic" id="userPic">
                </div>
                <div class="flex-grow-1 pl-3">
                  <strong id="nomeUsuario1"></strong>
                  <div class="text-muted small">Benvindo de volta</div>
                </div>
                <div>
                  <!-- <button class="btn btn-light border btn-lg px-3"> -->
                  <button class="btn btn-light">
                    <span style="font-size: 25px;" data-toggle="modal" data-target="#exampleModal"><ion-icon
                        name="create"></ion-icon></span>
                  </button>
                  <img src="" style="width: 35px;" id="bandeira">
                  <!-- </button> -->
                </div>
              </div>
            </div>
            <div class="position-relative">
              <div class="chat-messages p-4">
                <div class="wrapper">
                  <div class="profile-card js-profile-card">
                    <div class="profile-card__img">
                      <img src="assets/imgs/user.png" alt="profile card" id="userPic2">
                    </div>

                    <div class="profile-card__cnt js-profile-cnt">
                      <div class="profile-card__name" id="nomeUsuario2"></div>
                      <div class="profile-card__txt" id="emailUsuario2"></div>

                      <div class="profile-card-inf">
                        <div class="profile-card-inf__item">
                          <div class="profile-card-inf__title" id="dataConta"></div>
                          <div class="profile-card-inf__txt">Membro Desde</div>
                        </div>

                        <div class="profile-card-inf__item">
                          <div class="profile-card-inf__title" id="msgSend"></div>
                          <div class="profile-card-inf__txt">Mensagens Enviadas</div>
                        </div>

                        <div class="profile-card-inf__item">
                          <div class="profile-card-inf__title" id="msgReceive"></div>
                          <div class="profile-card-inf__txt">Mensagens Recebidas</div>
                        </div>
                      </div>

                    </div>

                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <style>
    /*PROFILEPIC*/
    ul.profilepic {list-style-type: none; padding-left: 0;display: flex;flex-wrap: wrap;justify-content: center;}
    .profilepic li {display: inline-block;}
    input[type="radio"] {display: none;}
    .profilepic label {border: 1px solid #fff;padding: 10px;display: block;position: relative;margin: 10px;cursor: pointer;}
    .profilepic label:before {background-color: white;color: white;content: " ";display: block;border-radius: 50%;border: 1px solid grey;position: absolute;top: -5px;left: -5px;width: 25px;height: 25px;text-align: center;line-height: 28px;transition-duration: 0.4s;transform: scale(0);}
    .profilepic label img {height: 40px;width: 40px;transition-duration: 0.2s;transform-origin: 50% 50%;}
    :checked + label {border-color: #ddd;}
    :checked + label:before {content: "✓";background-color: grey;transform: scale(1);}
    :checked + label img {transform: scale(0.9);box-shadow: 0 0 5px #333;z-index: -1;}
  </style>

  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Editar Perfil</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="formUpdate">
            <div class="form-group">
              <label for="exampleFormControlInput1">Nome</label>
              <input type="text" class="form-control" id="nome" placeholder="Nome">
            </div>
            <div class="form-group">
              <label for="exampleFormControlInput1">Endereço de Email</label>
              <input type="email" class="form-control" id="email" placeholder="name@example.com">
            </div>
            <div class="form-group">
              <label for="exampleFormControlSelect1">Língua</label>
              <select class="form-control" id="lingua">
                <option>PT</option>
                <option>EN</option>
                <option>FR</option>
              </select>
            </div>
            <div class="form-group">
              <label for="exampleFormControlInput1">Senha</label>
              <input type="password" class="form-control" id="password" placeholder="Deixe em branco para manter">
            </div>
            <p>Escolha a sua foto de perfil</p>
            <ul class="profilepic">
              <li><input type="radio" name="profilepic" id="profilepicUser" value="user.png" checked/>
                <label for="profilepicUser"><img src="assets/imgs/user.png"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic1" value="1.jpeg"/>
                <label for="profilepic1"><img src="assets/imgs/1.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic2" value="2.jpeg"/>
                <label for="profilepic2"><img src="assets/imgs/2.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic3" value="3.jpeg"/>
                <label for="profilepic3"><img src="assets/imgs/3.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic4" value="4.jpeg"/>
                <label for="profilepic4"><img src="assets/imgs/4.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic5" value="5.jpeg"/>
                <label for="profilepic5"><img src="assets/imgs/5.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic6" value="6.jpeg"/>
                <label for="profilepic6"><img src="assets/imgs/6.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic7" value="7.jpeg"/>
                <label for="profilepic7"><img src="assets/imgs/7.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic8" value="8.jpeg"/>
                <label for="profilepic8"><img src="assets/imgs/8.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic9" value="9.jpeg"/>
                <label for="profilepic9"><img src="assets/imgs/9.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic10" value="10.jpeg"/>
                <label for="profilepic10"><img src="assets/imgs/10.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic11" value="11.jpeg"/>
                <label for="profilepic11"><img src="assets/imgs/11.jpeg"/></label>
              </li>
              <li><input type="radio" name="profilepic" id="profilepic12" value="12.jpeg"/>
                <label for="profilepic12"><img src="assets/imgs/12.jpeg"/></label>
              </li>
            </ul>
            <button type="submit" class="btn btn-primary">Actualizar</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons.js"></script>
</body>

</html>
<script>
  var idUser = localStorage.getItem("idUser");
  if (!idUser) {
    window.location.href = "index.html";
  }
  window.addEventListener('load', async function () {
    try {
      const response = await fetch(`http://localhost:3000/home/${idUser}`);

      if (response.ok) {
        let data = await response.json()
        let usuario = data.dados_perfil[0];
        let outrosUsuarios = data.lista_contactos;
        let dataString = new Date(usuario.registrydate);
        let dia = dataString.getDate();
        let mes = dataString.getMonth() + 1;
        let ano = dataString.getFullYear();

        document.getElementById("nomeUsuario1").textContent = usuario.name;
        document.getElementById("nomeUsuario2").textContent = usuario.name;
        document.getElementById("userPic2").src = `assets/imgs/${usuario.profile}`;
        document.getElementById("userPic").src = `assets/imgs/${usuario.profile}`;
        document.getElementById("emailUsuario2").textContent = usuario.email;
        document.getElementById("bandeira").src = `assets/imgs/${usuario.language}.png`;
        document.getElementById("dataConta").textContent = `${dia}/${mes}/${ano}`;
      } else {
        alert('Erro: Não foi possível carregar os dados, tente novamente');
      }
    } catch (error) {
      console.error('Erro 1', error);
      alert('Erro: Não foi possível comunicar com o servidor, tente novamente');
    }
    //---------------------------------------------------------------------------
    //---------------------------------------------------------------------------
    try {
      const response = await fetch(`http://localhost:3000/home/messages/send/${idUser}`);

      if (response.ok) {
        let data = await response.json()
        console.log(data);
        if ("Não há mensagem nessa conversa" === data[0].msg) {
          document.getElementById("msgSend").textContent = "0";
        } else {
          document.getElementById("msgSend").textContent = `${data.length}`;
        }

      } else {
        alert('Erro: Não foi possível carregar os dados, tente novamente');
      }
    } catch (error) {
      console.error('Erro 1', error);
      alert('Erro: Não foi possível comunicar com o servidor, tente novamente');
    }
    //---------------------------------------------------------------------------
    //---------------------------------------------------------------------------
    try {
      const response = await fetch(`http://localhost:3000/home/messages/receive/${idUser}`);

      if (response.ok) {
        let data = await response.json()
        console.log(data);
        if ("Não há mensagem nessa conversa" === data[0].msg) {
          document.getElementById("msgReceive").textContent = "0";
        } else {
          document.getElementById("msgReceive").textContent = `${data.length}`;
        }

      } else {
        alert('Erro: Não foi possível carregar os dados, tente novamente');
      }
    } catch (error) {
      console.error('Erro 1', error);
      alert('Erro: Não foi possível comunicar com o servidor, tente novamente');
    }
  });

  document.getElementById("formUpdate").addEventListener("submit", function (event) {
    event.preventDefault();

    var nome = document.getElementById("nome").value;
    var email = document.getElementById("email").value;
    var lingua = document.getElementById("lingua").value;
    var password = document.getElementById("password").value;
    var profile = document.querySelector('input[name="profilepic"]:checked').value;

    email = email.toLowerCase();

    // Objeto com os dados a serem enviados na requisição
    var data = {
      profile: profile,
      name: nome,
      email: email,
      language: lingua,
      password: password
    };
    // Requisição POST para o servidor (substitua a URL pela URL real do seu backend)
    fetch(`http://localhost:3000/user/${idUser}/update`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na requisição');
        }
        return response.json();
      })
      .then(data => {
        document.getElementById("formUpdate").reset();
        alert(data[0].msg)
        window.location.reload();
      })
      .catch(error => {
        console.error('Erro:', error);
        alert("Erro...")
      });
  });

  function terminarSesao() {
      if (confirm("Queres terminar a sessão?")) {
        localStorage.removeItem("idUser");
        window.location.href = "index.html";
      }
    }
</script>